## overview

　psnvm は「インタプリタライクに実行できる c/c++」 を目標に設計されたスクリプト言語です。標準的な c/c++ のソースコードであれば、ほぼそのままpsnvmでも実行できるように配慮しています。

　ただし、インタプリタとして主に以下のような利用方法を想定して設計しているためいくつかc/c++とは互換性のない機能も存在します。

1. アプリケーションに組み込んで実行する
2. サーバーサイドプログラミング言語として使用する
3. 使い捨てのちょっとしたスクリプトとして使用する

　上記の中で特に注意したいのが(1)のアプリに組み込んで使用する場合です。こうした利用状況ではネットワークからスクリプトをダウンロードして実行するような使い方が想定されますが、信頼できないプログラムでのポインタアクセスやダイナミックライブラリのロードは非常に危険です。そのため、psnvmでは通常はポインタなどを使用することができなくなっています。ただし信頼できるプログラムの実を実行する場合や、意図してポインタを使用したい場合は制限なし実行モードを使用することでポインタなども使用できるようになります。これらの安全性については後ほど説明します。

　(2)のサーバーサイドにおける利用状況ではネットワークから受け取った信頼できないデータをパースするためのライブラリやDBから読み取ったデータなどを曖昧に処理するためのライブラリが標準でサポートされます。

　(3)の使い捨てプログラムのために、より簡易的にライブラリなどをインポートするための書式やevalなどが追加れれています。また、シバン（sheban）や標準でコンソール用のシェルとして実行できるモード、ドキュメント埋め込みモードが追加されています。

## sheban

UnixやそれににたOSで使用できる sheban に対応しています。ソースコードの１行目が #! で始まる場合、psnvmはシバンとして扱い、この行を無視します。また、UTF-8のBOMが含まれている場合、利便性を考えこのBOMをスキップします。

## document embed mode

　phpやjsp、aspといった言語や実行環境ではテキストとプログラムを混在したドキュメントを実行出来るようになっています。psnvmでも似たような機能が存在し、これをdocument embed mode（ドキュメント組み込みモード）と呼びます。ドキュメント組み込みモードでは以下のように文章とプログラムを混在できます。

```c++
<html>
<body>
<% printfmt("{04d/02d/02d 02d:02d}", extract...(new date())); %><br />
</body>
</html>
```

これはドキュメント組み込みモードでは以下のような結果になります。

```c++
<html>
<body>
2022/01/02 03:45<br />
</body>
</html>
```





## ref pointer と cur pointer

　ref pointerをより正確な言葉で言うなら referernce counter pointer になりますが、それだと呼びにくいので ref pointer と呼びます。またcur pointerはcursor pointerとなります。

　ref pointer はポインタが参照しているメモリやオブジェクトが実行中のプログラムで何か所から参照されているのかを管理しており、これにより循環参照を除けば正しくオブジェクトの寿命を管理できます。また、nullptrにアクセスしようとしれば例外を発生するなど安全なプログラミングが可能です。ただし、通常のポインタよりかはいくぶん暗黙的なオーバーヘッドがあります。

　cur pointerはいわゆるc/c++におけるイテレータに相当しますが、cur pointerそのものが参照先のオブジェクトの参照も保持します。そのためイテレータに比べてオーバーヘッドはありますが安全なプログラミングが可能です。

## Safe mode & Unsafe mode VM

　仮想マシンで実行する場合、Safe modeが存在します。Safe modeでは確保されたメモリの位置をVMで管理を行い、メモリへの読み書きが発生した際に管理されたメモリ内のアクセスであればメモリの読み書きを行いますが、範囲外であれば処理を無視します
（また例外を発生させます）。

　非Safe modeでは正しくないメモリ位置への読み書きが可能なため安全ではありませんが、動作が高速です。ただし、これは信頼できるプログラム以外の実行は控えてください。

　Safe modeではメモリの読み書きの際にメモリの範囲が正しいかどうかの確認を都度行いますので、動作は遅くなりますが範囲外メモリへのアクセスが禁止されるため比較的安全です。


## Safe mode & Unsafe mode compile

　psnvmにはコンパイル時にも safe modeとunsafe modeの指定が可能です。デフォルトは safe modeです。safe modeはポインタを扱う命令が無効になりますが、unsafe modeではポインタを扱う命令が有効になります。unsafe mode は主にc/c++のソースコードをそのまま流用するためのモードと言えます。unsafe なプログラムを safe にするには元のプログラムを書き換える必要があります。


　主な違いを表で表すと以下の通りになります。

x : unspport, o : ok

||safe|unsafe|
|--|--|--|
|pointer|x|o|
|ref pointer|o|o|
|cursor pointer|o|o|
|import library|x|o|
|import module|o|o|
