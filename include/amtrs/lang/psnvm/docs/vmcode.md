# Virtual machine

PSNVMとは特定のアーキテクチャに依存しない仮想マシンフォーマットです。
２バイト単位で構成されています。ただし一部の命令は４バイトまたは８バイトになります。


* 3個の専用レジスタと13個の汎用レジスタを持っています。
* REG[0] は常に 0 を指します。
* REG[1] はスタックポインタです。
* REG[2] はベースポインタです。


## OPECODE FORMAT

仮想マシンはワード単位(2bytes)の命令セットを持っています。

||D7|D6|D5|D4|D3|D2|D1|D0|
|:---:|:---:|:---:|:---:|:---:|:---:|:---:|:---:|:---:|
|+00H|>|>|>|EXT|>|>|>|CODE|
|+01H|>|>|>|>|>|>|>|EXT|

* CODE : 命令番号。
* EXT : 命令によって異なるパラメータ。

## OPECODE 0 : IMMIDIATE16

REG1 に IMM の値を書き込みます。

||D0|D1|D2|D3|D4|D5|D6|D7|
|:---:|:---:|:---:|:---:|:---:|:---:|:---:|:---:|:---:|
|+00H|>|>|>|REG1|CODE=0|
|+01H|>|>|>|>|>|>|>|IMM|

## OPECODE 1 : ACCESS16

REG1へREG2が示すメモリへ値をストアします。

||D7|D6|D5|D4|D3|D2|D1|D0|
|:---:|:---:|:---:|:---:|:---:|:---:|:---:|:---:|:---:|
|+00H|M|>|>|SIZE|CODE=1|
|+01H|>|>|>|REG1|>|>|>|REG2|

## OPECODE 2 : BINOPE16

REG1とREG2の演算結果をREG1へセットします。

```
REG1 = REG1 OPE REG2
```

||D7|D6|D5|D4|D3|D2|D1|D0|
|:---:|:---:|:---:|:---:|:---:|:---:|:---:|:---:|:---:|
|+00H|>|>|>|OPE|CODE=2|
|+01H|>|>|>|REG1|>|>|>|REG2|

## OPECODE 3 : SINGLEOPE16

REG2の演算結果をREG1へセットします。

```
REG1 = SOPE REG2
```

||D7|D6|D5|D4|D3|D2|D1|D0|
|:---:|:---:|:---:|:---:|:---:|:---:|:---:|:---:|:---:|
|+00H|>|>|>|SOPE|CODE=3|
|+01H|>|>|>|REG1|>|>|>|REG2|

|SOPE|Opecode|Detail|
|--|--|--|
|0|COPY|そのままの値|
|1|ABS|絶対値を求めます|
|2|NEG|算術的符号反転します|
|3|NOT|全てのビットを反転します|
|4|LNOT|論理的NOTを行います|
|5-7|>|未使用|

## OPECODE 4 : SPREG - SJMP

条件が一致するとき、COUNTで指定したワードサイズだけIPレジスタ(実行位置)を変更します。

||D7|D6|D5|D4|D3|D2|D1|D0|
|:---:|:---:|:---:|:---:|:---:|:---:|:---:|:---:|:---:|
|+00H|>|>|COND|0|CODE=4|
|+01H|>|>|>|>|>|>|>|COUNT|

## OPECODE 4 : SPREG - CALL(REG)/RET

REG1で指定するセグメントのREG2のプログラムをコールします。

R=1の場合はRET命令になる。F=1の場合はFARコールとして扱い、セグメントレジスタ、IPレジスタの両方を保存します。RETの場合はREG1, REG2 を無視します。

||D7|D6|D5|D4|D3|D2|D1|D0|
|:---:|:---:|:---:|:---:|:---:|:---:|:---:|:---:|:---:|
|+00H|R|F|0|1|CODE=4|
|+01H|>|>|>|REG1|>|>|>|REG2|

## OPECODE 4 : SPREG - PUSH/POP

V=0 なら PUSH, V=1 なら POP になります。

||D7|D6|D5|D4|D3|D2|D1|D0|
|:---:|:---:|:---:|:---:|:---:|:---:|:---:|:---:|:---:|
|+00H|V|0|1|1|CODE=4|
|+01H|>|>|>|REG1|0|0|0|0|

## OPECODE 4 : SPREG - STACK(IMM)

||D7|D6|D5|D4|D3|D2|D1|D0|
|:---:|:---:|:---:|:---:|:---:|:---:|:---:|:---:|:---:|
|+00H|0|1|1|1|CODE=4|
|+01H|V|>|>|>|>|>|>|IMM|

## OPECODE 4 : SPREG - STACK(REG)

||D7|D6|D5|D4|D3|D2|D1|D0|
|:---:|:---:|:---:|:---:|:---:|:---:|:---:|:---:|:---:|
|+00H|1|1|1|1|CODE=4|
|+01H|V|0|0|0|>|>|>|REG1|

## OPECODE 5 : IMMIDIATE-EX

REG1にIMMの値を書き込みます。LENによって追加データのサイズが変ります。

||D7|D6|D5|D4|D3|D2|D1|D0|
|:---:|:---:|:---:|:---:|:---:|:---:|:---:|:---:|:---:|
|+00H|M|>|>|LEN|CODE=5|
|+01H|>|>|>|REG1|>|>|>|SIZE|
|+02H|>|>|>|>|>|>|>|IMM|
|+03H|>|>|>|>|>|>|>|IMM|

|M|説明|
|--|--|
|0|即値をそのまま使う。SIZEを即値の拡張値として使用する。|
|1|DATA領域のオフセット値として扱い、SIZEで指定する値を読み取る|

|LEN|説明|
|--|--|
|0|追加無し。16 or 20Bitの即値|
|1|2ワード追加。32 or 36Bitの即値|
|2|4ワード追加。64 or 68Bitの即値|
|3-7|未使用|

## OPECODE 6 : ACCESS32, ACCESS64

```
IF S == 0 THEN ADDRESS = REG2 + REG3        + OFFSET
IF S == 1 THEN ADDRESS = REG2 + REG3 * SIZE + OFFSET
IF M == 0 THEN REG1 = *(SIZE)ADDRESS
IF M == 1 THEN *(SIZE)ADDRESS = REG1
```

||D7|D6|D5|D4|D3|D2|D1|D0|
|:---:|:---:|:---:|:---:|:---:|:---:|:---:|:---:|:---:|
|+00H|M|>|>|LEN|CODE=6|
|+01H|S|>|>|SIZE|>|>|>|REG1|
|+02H|>|>|>|REG2|>|>|>|REG3|
|+03H|>|>|>|>|>|>|>|OFFSET|


## OPECODE 7 : BINOPE32

REG2とREG3の演算結果をREG1へセットします。

```
REG1 = REG2 OPE REG3
```

||D7|D6|D5|D4|D3|D2|D1|D0|
|:---:|:---:|:---:|:---:|:---:|:---:|:---:|:---:|:---:|
|+00H|>|>|COND|0|CODE=7|
|+01H|>|>|>|OPE|>|>|>|REG1|
|+02H|>|>|>|REG2|>|>|>|REG3|


## OPECODE 8 : VCALL

REG2とREG3の演算結果をREG1へセットします。

```
REG1 = REG2 OPE REG3
```

||D7|D6|D5|D4|D3|D2|D1|D0|
|:---:|:---:|:---:|:---:|:---:|:---:|:---:|:---:|:---:|
|+00H|>|>|COND|0|CODE=7|
|+01H|>|>|>|OPE|>|>|>|REG1|
|+02H|>|>|>|REG2|>|>|>|REG3|

## 共通項目

### SIZE

通常 3bit の値で表される。

|SIZE|LENGTH|
|:---:|:---|
|0|8bit|
|1|16bit|
|2|32bit|
|3|64bit|
|4-7|未定義|

浮動小数モードでは次のように扱われる

|SIZE|LENGTH|
|:---:|:---|
|0|32bit|
|1|64bit|
|3-7|未定義|

SIMD(64, 128)モードでは次のように扱われる

|SIZE|LENGTH|
|:---:|:---|
|0|8bit x N|
|1|16bit x N|
|2|32bit x N|
|3|64bit x N|
|4|128bit x N|
|5-7|未定義|

## COND

条件式を示す3bitの値

|COND|Expr|Flags|
|--|--|--|
|0|a == b|ZF=0|
|1|a != b|ZF=1|
|2|a > b|SF=0|
|3|a >= b|SF=0 OR ZF = 1|
|4|a < b|SF=1|
|5|a <= b|SF=1 OR ZF = 1|
|6-7|>|未定義|

## OPE

演算を示す4bitの値

|OPE|Operation|
|--|--|
|0|ADD|
|1|SUB|
|2|MUL|
|3|IMUL|
|4|DIV|
|5|IDIV|
|6|MOD|
|7|IMOD|
|8|BIT OR|
|9|BIT XOR|
|10|BIT AND|
|11|SHIFT LEFT|
|12|SHIFT RIGHT|
|13|SHIFT RIGHT SINGNED|
|14|LOGICAL OR|
|15|LOGICAL AND|
